<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Partner Registration - LifeLink</title>
    <link rel="stylesheet" href="./css/register.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div class="container">
        <div class="glass-card">
            <h1 class="text-center">Register a Pharmacy</h1>
            <p class="text-center" style="margin-bottom: 20px;">
                Add a new shop to your portfolio. <br>
                <span id="userEmailDisplay" style="color:black; font-weight:bold;"></span>
            </p>

            <div id="existingShopsMsg" class="hidden text-center" style="background:#e3f2fd; color:#0d47a1; padding:10px; border-radius:8px; margin-bottom:20px; border:1px solid #bbdefb;">
                </div>

            <div id="regForm">
                <label>Shop Name</label>
                <input type="text" id="name" placeholder="e.g. Apollo Pharmacy (Branch 2)">
                <br><br>

                <div style="background: #f1f8f1; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color:#2E7D32; margin-top:0;">üìç Shop Location</h3>
                    <div class="grid-2">
                        <div>
                            <label>Address (Area)</label>
                            <input type="text" id="address" placeholder="e.g. Salt Lake">
                        </div>
                        <div>
                            <label>Pincode</label>
                            <input type="text" id="pincode" placeholder="e.g. 700091">
                        </div>
                    </div>
                    <br>
                    
                    <div class="grid-2">
                        <button type="button" onclick="locateOnMap()" class="btn-secondary">
                            üîç Search Address
                        </button>
                        <button type="button" onclick="useCurrentLocation()" id="geoBtn" class="btn-secondary" style="background: #e8f5e9; border-color: #2E7D32;">
                            <i class="fas fa-location-arrow"></i> Use Current Location
                        </button>
                    </div>
                    
                    <br>
                    <div id="map"></div>
                    <p class="text-center" style="color: #2E7D32; font-size: 0.9em; margin-top: 10px;">
                        üëá Drag the marker to set exact entrance location
                    </p>
                </div>

                <label>Phone Number</label>
                <input type="text" id="phone" placeholder="e.g. 9876543210">
                <br><br>

                <div style="display: flex; align-items: center; gap: 10px; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #ddd;">
                    <input type="checkbox" id="isOpen247" style="width: 20px; height: 20px; accent-color: #2E7D32;">
                    <label for="isOpen247" style="margin:0; cursor:pointer;">Open 24/7 (Emergency Service)</label>
                </div>
                <br>

                <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px; color:#2E7D32;">Official Verification</h3>
                <p style="font-size: 0.8em; color: red;">* Licenses must be unique.</p>

                <label>Drug License No.</label>
                <input type="text" id="dlNum" placeholder="e.g. WB/KOL/1234/2023">
                <br><br>

                <div class="grid-2">
                    <div>
                        <label>Owner PAN</label>
                        <input type="text" id="panNum" placeholder="ABCDE1234F">
                    </div>
                    <div>
                        <label>GSTIN</label>
                        <input type="text" id="gstin" placeholder="22AAAAA0000A1Z5">
                    </div>
                </div>
                <br>
                
                <button onclick="registerShop()" class="btn-primary">Submit Registration</button>
                <p id="msg" class="text-center" style="margin-top: 20px; font-weight: bold;"></p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script type="module">
        import { auth, db } from './js/firebase.js'; 
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        let currentUser = null;
        let map, marker, selectedLat, selectedLon;

        function initMap() {
            map = L.map('map').setView([22.5726, 88.3639], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap & CARTO', maxZoom: 19
            }).addTo(map);
            marker = L.marker([22.5726, 88.3639], { draggable: true }).addTo(map);
            marker.on('dragend', function(e) {
                const pos = marker.getLatLng();
                selectedLat = pos.lat; selectedLon = pos.lng;
            });
        }
        initMap();

        function updateMapPosition(lat, lon) {
            map.setView([lat, lon], 16);
            marker.setLatLng([lat, lon]);
            selectedLat = lat; selectedLon = lon;
        }

        window.locateOnMap = async function() {
            const address = document.getElementById('address').value;
            const pincode = document.getElementById('pincode').value;
            if(!address || !pincode) return alert("Enter Address & Pincode");
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${address}, ${pincode}&format=json&limit=1`);
                const data = await res.json();
                if (data.length > 0) updateMapPosition(parseFloat(data[0].lat), parseFloat(data[0].lon));
                else alert("Address not found.");
            } catch (e) { console.error(e); }
        }

        window.useCurrentLocation = function() {
            if (!navigator.geolocation) return alert("Geolocation not supported.");
            const btn = document.getElementById('geoBtn');
            const txt = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Locating...`; btn.disabled = true;

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude: lat, longitude: lon } = pos.coords;
                updateMapPosition(lat, lon);
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                    const data = await res.json();
                    if(data && data.address) {
                        if(data.address.postcode) document.getElementById('pincode').value = data.address.postcode;
                        const parts = [data.address.road, data.address.suburb, data.address.city].filter(Boolean);
                        document.getElementById('address').value = parts.join(", ");
                    }
                } catch(e){}
                btn.innerHTML = txt; btn.disabled = false;
            }, () => { alert("Location denied."); btn.innerHTML = txt; btn.disabled = false; });
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userEmailDisplay').innerText = `Logged in as: ${user.email}`;
                checkExistingShops(user.uid);
            } else { window.location.href = "index.html"; }
        });

        async function checkExistingShops(uid) {
            const q = query(collection(db, "shops"), where("ownerId", "==", uid));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                const count = snapshot.size;
                const msgDiv = document.getElementById('existingShopsMsg');
                msgDiv.innerHTML = `‚ÑπÔ∏è <b>You already have ${count} shop(s).</b> <a href="manage-shop.html">Manage them here</a>`;
                msgDiv.classList.remove('hidden');
            }
        }

        window.registerShop = async function() {
            if (!currentUser) return alert("Login required!");
            
            const name = document.getElementById('name').value;
            const address = document.getElementById('address').value;
            const pincode = document.getElementById('pincode').value;
            const phone = document.getElementById('phone').value;
            const dlNum = document.getElementById('dlNum').value.trim();
            const panNum = document.getElementById('panNum').value;
            const gstin = document.getElementById('gstin').value.trim();
            const isOpen247 = document.getElementById('isOpen247').checked;
            const msg = document.getElementById('msg');

            if(!selectedLat || !selectedLon) return alert("Please set location on map.");
            if(!name || !address || !pincode || !phone || !dlNum || !gstin) return alert("Fill all fields.");

            msg.innerText = "Verifying..."; msg.style.color = "blue";

            try {
                // Unique Checks
                const qGstin = query(collection(db, "shops"), where("gstin", "==", gstin));
                const snapGstin = await getDocs(qGstin);
                if (!snapGstin.empty) { msg.innerText = "Error: GSTIN already used!"; msg.style.color = "red"; return; }

                const qDl = query(collection(db, "shops"), where("dlNum", "==", dlNum));
                const snapDl = await getDocs(qDl);
                if (!snapDl.empty) { msg.innerText = "Error: License already used!"; msg.style.color = "red"; return; }

                await addDoc(collection(db, "shops"), {
                    ownerId: currentUser.uid, ownerEmail: currentUser.email,
                    name, address, pincode, phone, gstin, dlNum, panNum, isOpen247,
                    lat: selectedLat, lon: selectedLon,
                    status: 'pending', createdAt: serverTimestamp()
                });

                msg.innerText = "Success! Redirecting..."; msg.style.color = "green";
                setTimeout(() => window.location.href = "manage-shop.html", 2000);
            } catch (e) {
                console.error(e); msg.innerText = "Error: " + e.message; msg.style.color = "red";
            }
        }
    </script>
</body>
</html>