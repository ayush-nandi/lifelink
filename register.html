<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Partner Registration - LifeLink</title>
    <link rel="stylesheet" href="partner.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>

    <div class="container">
        <div class="glass-card">
            <h1 class="text-center">Register Your Pharmacy</h1>
            <p class="text-center" style="color:#666; margin-bottom: 30px;">
                Join the LifeLink network. <br>
                <span id="userEmailDisplay" style="color:black; font-weight:bold;"></span>
            </p>

            <div id="regForm">
                <label>Shop Name</label>
                <input type="text" id="name" placeholder="e.g. Apollo Pharmacy">
                <br><br>

                <div style="background: #f1f8f1; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">üìç Shop Location</h3>
                    <div class="grid-2">
                        <div>
                            <label>Address (Area)</label>
                            <input type="text" id="address" placeholder="e.g. Salt Lake">
                        </div>
                        <div>
                            <label>Pincode</label>
                            <input type="text" id="pincode" placeholder="e.g. 700091">
                        </div>
                    </div>
                    <br>
                    <button type="button" onclick="locateOnMap()" class="btn-secondary">
                        üîç Search Address on Map
                    </button>
                    <br><br>
                    <div id="map"></div>
                    <p class="text-center" style="color: #2E7D32; font-size: 0.9em; margin-top: 10px;">
                        üëá Drag the marker to set exact location
                    </p>
                </div>

                <label>Phone Number</label>
                <input type="text" id="phone" placeholder="e.g. 9876543210">
                <br><br>

                <div style="display: flex; align-items: center; gap: 10px; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #ddd;">
                    <input type="checkbox" id="isOpen247" style="width: 20px; height: 20px; accent-color: #2E7D32;">
                    <label for="isOpen247" style="margin:0; cursor:pointer;">Open 24/7 (Emergency Service)</label>
                </div>
                <br>

                <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">Official Verification</h3>
                <p style="font-size: 0.8em; color: red;">* Private data for admin use only.</p>

                <label>Drug License No.</label>
                <input type="text" id="dlNum" placeholder="e.g. WB/KOL/1234/2023">
                <br><br>

                <div class="grid-2">
                    <div>
                        <label>Owner PAN</label>
                        <input type="text" id="panNum" placeholder="ABCDE1234F">
                    </div>
                    <div>
                        <label>GSTIN</label>
                        <input type="text" id="gstin" placeholder="22AAAAA0000A1Z5">
                    </div>
                </div>
                <br>
                
                <button onclick="registerShop()" class="btn-primary">Submit Registration</button>
                <p id="msg" class="text-center" style="margin-top: 20px; font-weight: bold;"></p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { auth, db } from './js/firebase.js'; 
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        let currentUser = null;
        let map, marker, selectedLat, selectedLon;

        // Map Init
        function initMap() {
            map = L.map('map').setView([22.5726, 88.3639], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap & CARTO', maxZoom: 19
            }).addTo(map);
            marker = L.marker([22.5726, 88.3639], { draggable: true }).addTo(map);
            marker.on('dragend', function(e) {
                const pos = marker.getLatLng();
                selectedLat = pos.lat; selectedLon = pos.lng;
            });
        }
        initMap();

        // Locate Logic
        window.locateOnMap = async function() {
            const address = document.getElementById('address').value;
            const pincode = document.getElementById('pincode').value;
            if(!address || !pincode) return alert("Enter Address & Pincode");
            
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${address}, ${pincode}&format=json&limit=1`);
                const data = await res.json();
                if (data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    map.setView([lat, lon], 16);
                    marker.setLatLng([lat, lon]);
                    selectedLat = lat; selectedLon = lon;
                } else { alert("Address not found."); }
            } catch (e) { console.error(e); }
        }

        // Auth Logic
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userEmailDisplay').innerText = `Logged in as: ${user.email}`;
                checkIfAlreadyRegistered(user.uid);
            } else { window.location.href = "index.html"; }
        });

        async function checkIfAlreadyRegistered(uid) {
            const q = query(collection(db, "shops"), where("ownerId", "==", uid));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                document.getElementById('regForm').innerHTML = `
                    <div class="text-center">
                        <h2 style="color: #2E7D32;">‚úÖ You have a shop!</h2>
                        <br>
                        <a href="manage-shop.html" class="btn-primary" style="display:inline-block; width:auto; padding: 15px 30px;">Go to Dashboard</a>
                    </div>`;
            }
        }

        // Register Logic
        window.registerShop = async function() {
            if (!currentUser) return alert("Login required!");
            
            const name = document.getElementById('name').value;
            const address = document.getElementById('address').value;
            const pincode = document.getElementById('pincode').value;
            const phone = document.getElementById('phone').value;
            const dlNum = document.getElementById('dlNum').value;
            const panNum = document.getElementById('panNum').value;
            const gstin = document.getElementById('gstin').value;
            const isOpen247 = document.getElementById('isOpen247').checked;
            const msg = document.getElementById('msg');

            if(!selectedLat || !selectedLon) return alert("Please set location on map.");
            if(!name || !address || !pincode || !phone || !dlNum) return alert("Fill all fields.");

            msg.innerText = "Processing...";
            msg.style.color = "blue";

            try {
                await addDoc(collection(db, "shops"), {
                    ownerId: currentUser.uid,
                    ownerEmail: currentUser.email,
                    name, address, pincode, phone, gstin, dlNum, panNum, isOpen247,
                    lat: selectedLat, lon: selectedLon,
                    status: 'pending', createdAt: serverTimestamp()
                });
                msg.innerText = "Success! Redirecting...";
                msg.style.color = "green";
                setTimeout(() => window.location.href = "manage-shop.html", 2000);
            } catch (e) {
                console.error(e);
                msg.innerText = "Error: " + e.message;
                msg.style.color = "red";
            }
        }
    </script>
</body>
</html>