<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Partner Registration - MediFinder</title>
    <link rel="stylesheet" href="shops.css">

</head>
<body>
    <div class="container" style="max-width: 600px; margin-top: 30px;">
        <h1>Register Your Shop</h1>
        <p style="color:gray; font-size: 0.9em;">Join our verified network of pharmacies.</p>

        <div class="shop-card" style="display:block;">
            
            <label>Shop Name:</label>
            <input type="text" id="name" placeholder="e.g. Apollo Pharmacy" style="width:100%; padding:10px; margin-bottom:10px;">

            <label>Address (Area/Street):</label>
            <input type="text" id="address" placeholder="e.g. Salt Lake Sector 5" style="width:100%; padding:10px; margin-bottom:10px;">

            <label>Pincode:</label>
            <input type="text" id="pincode" placeholder="e.g. 700091" style="width:100%; padding:10px; margin-bottom:10px;">

            <label>Phone Number:</label>
            <input type="text" id="phone" placeholder="e.g. 9876543210" style="width:100%; padding:10px; margin-bottom:10px;">

            <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; background: #e8f5e9; padding: 10px; border-radius: 5px;">
                <input type="checkbox" id="isOpen247" style="width: 20px; height: 20px;">
                <label for="isOpen247" style="margin: 0; font-weight: bold; color: #2e7d32;">This shop is open 24/7 (Emergency Service)</label>
            </div>

            <hr style="border: 0; border-top: 1px solid #ddd; margin: 20px 0;">
            <h3 style="margin-bottom: 15px;">Official Verification Documents</h3>

            <label>Drug License Number (DL No.):</label>
            <input type="text" id="dlNum" placeholder="e.g. WB/KOL/1234/2023" style="width:100%; padding:10px; margin-bottom:10px; border: 1px solid #007bff;">

            <label>Owner's PAN Card Number:</label>
            <input type="text" id="panNum" placeholder="e.g. ABCDE1234F" style="width:100%; padding:10px; margin-bottom:10px; border: 1px solid #007bff;">

            <label>GSTIN:</label>
            <input type="text" id="gstin" placeholder="22AAAAA0000A1Z5" style="width:100%; padding:10px; margin-bottom:10px; border: 1px solid #007bff;">
            
            <small style="display:block; margin-bottom:15px; color:red;">* Official documents are for internal verification only and will NOT be public.</small>
            
            <button onclick="registerShop()" style="width:100%; padding:12px; background:#007bff; color:white; border:none; font-size: 16px; cursor: pointer; border-radius: 5px;">
                Submit for Verification
            </button>
            <p id="msg" style="margin-top:10px; font-weight: bold;"></p>
        </div>
        <br>
        <a href="shops.html">Back to Map</a>
    </div>

<script type="module">
        // 1. IMPORT DB FROM YOUR SHARED FILE
        // Make sure the path is correct! If firebase.js is in a 'js' folder, use './js/firebase.js'
        import { db } from './js/firebase.js'; 
        
        // 2. IMPORT FUNCTIONS WE NEED FROM FIREBASE WEB
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // 3. DEFINE FUNCTION
        // Since this is a module, we must attach the function to 'window' to make it clickable from HTML
        window.registerShop = async function() {
            const name = document.getElementById('name').value;
            const address = document.getElementById('address').value;
            const pincode = document.getElementById('pincode').value;
            const phone = document.getElementById('phone').value;
            const dlNum = document.getElementById('dlNum').value;
            const panNum = document.getElementById('panNum').value;
            const gstin = document.getElementById('gstin').value;
            const isOpen247 = document.getElementById('isOpen247').checked;
            const msg = document.getElementById('msg');

            if(!name || !address || !pincode || !phone || !dlNum || !panNum) {
                return alert("Please fill all required fields.");
            }

            msg.innerText = "Verifying location...";
            msg.style.color = "blue";

            try {
                // Geocode (Same as before)
                const fullAddress = `${address}, ${pincode}`;
                const geoUrl = `https://nominatim.openstreetmap.org/search?q=${fullAddress}&format=json&limit=1`;
                const response = await fetch(geoUrl);
                const data = await response.json();

                if (data.length === 0) {
                    msg.innerText = "Location not found! Check address/pincode.";
                    msg.style.color = "red";
                    return;
                }

                // SAVE TO FIREBASE (NEW MODULAR SYNTAX)
                await addDoc(collection(db, "shops"), {
                    name: name,
                    address: address,
                    pincode: pincode,
                    phone: phone,
                    gstin: gstin,
                    dlNum: dlNum,
                    panNum: panNum,
                    isOpen247: isOpen247,
                    lat: parseFloat(data[0].lat),
                    lon: parseFloat(data[0].lon),
                    status: 'pending',
                    createdAt: serverTimestamp() // Using the imported function
                });

                msg.innerText = "Success! Application submitted for review.";
                msg.style.color = "green";
                
                // Clear form inputs...
                document.getElementById('name').value = "";
                document.getElementById('dlNum').value = "";

            } catch (err) {
                console.error("Firebase Error:", err);
                msg.innerText = "Error: " + err.message;
                msg.style.color = "red";
            }
        }
    </script>
</body>
</html>