<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Shop - LifeLink</title>
    <link rel="stylesheet" href="partner.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>

    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h1>My Pharmacy</h1>
            <a href="dashboard.html" style="color: #607d8b; font-weight: bold;">‚Üê Back to Dashboard</a>
        </div>

        <div id="loading" class="text-center" style="padding: 50px;">
            <p>Loading your shop details...</p>
        </div>

        <div id="noShop" class="glass-card hidden text-center">
            <h2>No Shop Found</h2>
            <p>You haven't registered a pharmacy yet.</p>
            <br>
            <a href="register.html" class="btn-primary" style="display:inline-block; width:auto; padding: 12px 30px;">Register Now</a>
        </div>

        <div id="editForm" class="glass-card hidden">
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:20px;">
                <h2>Edit Details</h2>
                <span id="statusBadge" class="status-badge">Loading...</span>
            </div>

            <label>Shop Name</label>
            <input type="text" id="editName">
            <br><br>

            <div style="background: #f1f8f1; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">üìç Update Location</h3>
                <div class="grid-2">
                    <div>
                        <label>Address</label>
                        <input type="text" id="editAddress">
                    </div>
                    <div>
                        <label>Pincode</label>
                        <input type="text" id="editPincode">
                    </div>
                </div>
                <br>
                <button type="button" onclick="locateOnMap()" class="btn-secondary">Move Map to this Address</button>
                <br><br>
                <div id="map"></div>
                <p class="text-center" style="color: #2E7D32; font-size: 0.9em; margin-top: 10px;">üëá Drag marker to adjust</p>
            </div>

            <label>Phone Number</label>
            <input type="text" id="editPhone">
            <br><br>

            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="editIsOpen247" style="width: 20px; height: 20px; accent-color: #2E7D32;">
                <label for="editIsOpen247" style="margin:0; cursor:pointer;">Open 24/7</label>
            </div>
            <br>

            <div style="background: #f9f9f9; padding: 15px; border-radius: 12px; border: 1px solid #eee;">
                <h4 style="margin:0 0 10px 0; color:#999; text-transform:uppercase; font-size:0.8em;">Locked Official Data</h4>
                <div class="grid-2">
                    <div>
                        <p style="margin:0; font-size:0.8em; color:#666;">Drug License</p>
                        <p id="viewDl" style="font-weight:bold; margin-top:5px;">Loading...</p>
                    </div>
                    <div>
                        <p style="margin:0; font-size:0.8em; color:#666;">GSTIN</p>
                        <p id="viewGstin" style="font-weight:bold; margin-top:5px;">Loading...</p>
                    </div>
                </div>
            </div>
            <br>

            <div class="grid-2">
                <button onclick="updateShop()" class="btn-primary">Save Changes</button>
                <a href="dashboard.html" class="btn-secondary" style="text-align:center; text-decoration:none; display:flex; align-items:center; justify-content:center;">Cancel</a>
            </div>
            <p id="updateMsg" class="text-center" style="font-weight:bold; margin-top:15px;"></p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { auth, db } from './js/firebase.js'; 
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { collection, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        let myShopId = null;
        let map, marker, selectedLat, selectedLon;

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = "index.html"; return; }

            const q = query(collection(db, "shops"), where("ownerId", "==", user.uid));
            const snapshot = await getDocs(q);
            document.getElementById('loading').classList.add('hidden');

            if (snapshot.empty) {
                document.getElementById('noShop').classList.remove('hidden');
            } else {
                const docSnap = snapshot.docs[0];
                const data = docSnap.data();
                myShopId = docSnap.id;

                document.getElementById('editForm').classList.remove('hidden');
                document.getElementById('editName').value = data.name;
                document.getElementById('editAddress').value = data.address;
                document.getElementById('editPincode').value = data.pincode;
                document.getElementById('editPhone').value = data.phone;
                document.getElementById('editIsOpen247').checked = data.isOpen247;
                document.getElementById('viewDl').innerText = data.dlNum || "N/A";
                document.getElementById('viewGstin').innerText = data.gstin || "N/A";

                const badge = document.getElementById('statusBadge');
                badge.innerText = data.status;
                badge.className = `status-badge status-${data.status}`;

                selectedLat = data.lat; selectedLon = data.lon;
                initMap(data.lat, data.lon);
            }
        });

        function initMap(lat, lon) {
            if(!lat || !lon) { lat=22.5726; lon=88.3639; }
            map = L.map('map').setView([lat, lon], 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '¬© OpenStreetMap & CARTO', maxZoom: 19 }).addTo(map);
            marker = L.marker([lat, lon], { draggable: true }).addTo(map);
            marker.on('dragend', function(e) { const pos = marker.getLatLng(); selectedLat = pos.lat; selectedLon = pos.lng; });
        }

        window.locateOnMap = async function() {
            const address = document.getElementById('editAddress').value;
            const pincode = document.getElementById('editPincode').value;
            if(!address || !pincode) return alert("Enter Address & Pincode");
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${address}, ${pincode}&format=json&limit=1`);
                const data = await res.json();
                if (data.length > 0) {
                    const lat = parseFloat(data[0].lat); const lon = parseFloat(data[0].lon);
                    map.setView([lat, lon], 16); marker.setLatLng([lat, lon]);
                    selectedLat = lat; selectedLon = lon;
                } else { alert("Address not found."); }
            } catch (e) { console.error(e); }
        }

        window.updateShop = async function() {
            if(!myShopId) return;
            const msg = document.getElementById('updateMsg');
            msg.innerText = "Updating..."; msg.style.color = "blue";
            
            try {
                await updateDoc(doc(db, "shops", myShopId), {
                    name: document.getElementById('editName').value,
                    address: document.getElementById('editAddress').value,
                    pincode: document.getElementById('editPincode').value,
                    phone: document.getElementById('editPhone').value,
                    isOpen247: document.getElementById('editIsOpen247').checked,
                    lat: selectedLat, lon: selectedLon
                });
                msg.innerText = "Saved Successfully!"; msg.style.color = "green";
            } catch (e) {
                console.error(e); msg.innerText = "Error: " + e.message; msg.style.color = "red";
            }
        }
    </script>
</body>
</html>